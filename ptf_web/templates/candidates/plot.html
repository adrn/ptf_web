{% extends "layout.html" %}

{% block head %}
    {{ super() }}
    
    <script src="//ajax.googleapis.com/ajax/libs/jquery/1.6.0/jquery.min.js"></script>
    <script src="{{ url_for('static', filename='js/graph/js/jquery.graph.js') }}"></script>
    
    <script type="text/javascript">
        /* Misc. Useful functions */
        array_max = function( array ){
            return Math.max.apply( Math, array );
        };
        
        array_min = function( array ){
            return Math.min.apply( Math, array );
        };

        String.prototype.format = String.prototype.f = function() {
            var s = this,
                i = arguments.length;
        
            while (i--) {
                s = s.replace(new RegExp('\\{' + i + '\\}', 'gm'), arguments[i]);
            }
            return s;
        };
        
        /* -------------------------------------------------- */
        
        function dataReceived(data) {
            var plot_data = [];
            for (ii in data.light_curve.mjd) {
                plot_data[ii] = {"x" : data.light_curve.mjd[ii], "y" : -data.light_curve.mag[ii], "err" : data.light_curve.error[ii]};
            }

            // Define some options
            options = {
                xaxis:{ label:'Day (MJD - Epoch)' },
                yaxis: { label: 'R (mag)' }
            };
            
            // Set data-dependent fields
            var baseline = array_max(data.light_curve.mjd) - array_min(data.light_curve.mjd);
            $("#numObservations").text("" + plot_data.length);
            $("#baseline").text("" + parseInt(baseline) + " days");
            $("#ra").text("" + data.light_curve.ra.toFixed(5));
            $("#dec").text("" + data.light_curve.dec.toFixed(5));
            
            // Set SDSS link url
            var sdssURL = "http://cas.sdss.org/dr7/en/tools/search/x_radial.asp?ra={0}&dec={1}&radius=5&format=csv&topnum=20".format(data.light_curve.ra.toFixed(7), data.light_curve.dec.toFixed(7));
            $("#sdssLink").attr("href", sdssURL);
            
            // Set SIMBAD link url
            var simbadURL = "http://simbad.u-strasbg.fr/simbad/sim-coo?Coord={0}%20{1}&Radius=10&Radius.unit=arcsec".format(data.light_curve.ra.toFixed(7), data.light_curve.dec.toFixed(7));
            $("#simbadLink").attr("href", simbadURL);
            
            // Set SDSS image link
            var sdssImageURL = "http://casjobs.sdss.org/ImgCutoutDR7/getjpeg.aspx?ra={0}&dec={1}&width=40&height=40".format(data.light_curve.ra.toFixed(7), data.light_curve.dec.toFixed(7));
            $("#sdssImage").attr("src", sdssImageURL);
            
            // Set PTF image link
            var ptfImageURL = "/ptfimage?field_id={{ field_id }}&ccd_id={{ ccd_id }}&source_id={{ source_id }}";
            $("#ptfImage").attr("src", ptfImageURL);
            
            // Set status text
            var status = data.light_curve.status;
            var statusColor;
            
            if (status == "Galaxy") {
                statusColor = "rgba(44, 123, 182, 0.5)";
            } else if (status == "Boring") {
               statusColor = "rgba(171, 217, 233, 0.75)";
            } else if (status == "Interesting") {
                statusColor = "rgba(253, 174, 97, 0.75)";
            } else if (status == "Candidate") {
                statusColor = "rgba(215, 25, 28, 0.5)";
            } else {
                $("#statusBanner").css("display", "none");
            }
            
            $("#statusBanner").text("" + data.light_curve.status);
            $("#statusBanner").css("background-color", statusColor);
            
            // Setup the graph
            var graph = $.graph('placeholder', {
                data: plot_data,
                color: "#1E67BA",
                points: { show: true, radius: 3 },
                lines: { show: false, width: 2 },
                hoverable: true, 
                clickable: true
            }, options);
            
        }
        
        function parsePTFImageQuery(textData) {
            alert(textData);   
        }
        
        $(document).ready(function() {
            $.ajax({
                type: "GET",
                url: "/json/candidate_data?field_id={{ field_id }}&ccd_id={{ ccd_id }}&source_id={{ source_id }}",
                contentType: "application/json; charset=utf-8",
                dataType: "json",
                success: dataReceived
            });
        });
    </script>
               
    
{% endblock %}

{% block body %}
    
    <table width="1400px" class="info">
        <tr class="status">
            <td colspan="8" id="statusBanner">
            </td>
        </tr>
        <tr class="titles">
            <td><font class="key">Field ID:</font> <font class="val">{{field_id}}</font></td>
            <td><font class="key">CCD ID:</font> <font class="val">{{ccd_id}}</font></td>
            <td><font class="key">Source ID:</font> <font class="val">{{source_id}}</font></td>
            <td><font class="key">Num. Observations:</font> <font class="val" id="numObservations"></font></td>
            <td><font class="key">Baseline:</font> <font class="val" id="baseline"></font></td>
            <td><font class="key">RA:</font> <font class="val" id="ra"></font></td>
            <td><font class="key">Dec:</font> <font class="val" id="dec"></font></td>
            <td>
                <a target="_blank" id="simbadLink">Search in SIMBAD</a><br/>
                <a target="_blank" id="sdssLink">Search in SDSS</a>
            </td>
        </tr>
    </table>
    <br/>
    
    <table width="100%">
        <tr>
            <td width="80%"><div id="placeholder" style="width:100%;height:650px;z-index:10000;"></div></td>
            <td align="center">
                
                <form method="get">
                    <input type="hidden" name="field_id" value="{{ field_id }}" />
                    <input type="hidden" name="ccd_id" value="{{ ccd_id }}" />
                    <input type="hidden" name="source_id" value="{{ source_id }}" />
                    <input type="hidden" name="update_status" value="true" />
                    
                    <input type="submit" id="flagAsGalaxy" name="status" value="Galaxy" class="galaxy" />
                    <input type="submit" id="flagAsBoring" name="status" value="Boring" class="boring" /><br/><br/>
                    <input type="submit" id="flagAsInteresting" name="status" value="Interesting" class="interesting" />
                    <input type="submit" id="flagAsCandidate" name="status" value="Candidate" class="candidate" />
                </form>
                
                <br/><br/>
                <hr width="75%"/>
                <br/>
                
                SDSS Image<br/>
                <img id="sdssImage" width="200" height="200" onerror="this.src='{{ url_for('static', filename='images/no-image.jpg') }}';" />
                <br/><br/>
                <!-- TODO: Make this optional (button 'Load PTF Image')
                PTF Image<br/>
                <img id="ptfImage" height="200px" onerror="this.src='{{ url_for('static', filename='images/no-image.jpg') }}';" />
                -->
            </td>
            
        </tr>
        <tr>
            <td></td>
            <td align="center"></td>
        </tr>
    </table>
    <!--<input id="reset" type="button" value="Reset axes" />-->
        
    <!--<pre><span class=ig>some code!</span></pre>-->

<!--<a href="http://github.com/mitsuhiko/flask"><img style="position: fixed; top: 0; right: 0; border: 0;"
  src="http://s3.amazonaws.com/github/ribbons/forkme_right_gray_6d6d6d.png" alt="Fork me on GitHub"></a>-->
{% endblock %}